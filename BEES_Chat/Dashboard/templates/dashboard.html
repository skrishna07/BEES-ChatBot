{% extends 'layouts/base.html' %} 
{% block title %} Dashboard {% endblock title%}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}

{% endblock stylesheets %} 
{% block content %}

<!-- Header -->
<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <!-- Card stats -->
    </div>
  </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="row">
    <div class="col">
      <div class="card">
        <!-- Card header -->
        <div class="card-header border-0">
          <h3 class="mb-0">Chat History</h3>
        </div>

        <div class="mt-3 ml-3">
          <label for="from-date">From: </label>
          <input type="text" id="from-date" class="datepicker" required/>
          <label for="to-date">To: </label>
          <input type="text" id="to-date" class="datepicker" required/>
          <button class="btn btn-success" id="filter">Filter</button>
          <button class="btn btn-danger" id="resetBtn">Reset</button>
        </div>
        <br /><br />
        <table id="chatHistory" class="display">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Session ID</th>
              <th>IP Address</th>
              <th>Token Used</th>
              <th>Tokens Cost</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populate this with chat history data -->
          </tbody>
          <tfoot>
            <tr>
                <th colspan="4">Total:</th>
                <th></th>
                <th></th>
            </tr>
        </tfoot>
        </table>
      </div>
    </div>
    <!-- Dark table -->
  </div>

  {% endblock content %}

  <!-- Specific JS goes HERE -->
  {% block javascripts %}
  <script src="/static/assets/vendor/chart.js/dist/Chart.min.js"></script>
  <script src="/static/assets/vendor/chart.js/dist/Chart.extension.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    $(document).ready(function() {
        var table=$('#chatHistory').DataTable({
          "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
          "processing": true,
          "serverSide": true,
          buttons: [
              
              {
                  extend: 'excelHtml5',
                  text: 'Export Excel',
                  exportOptions: {
                    columns: ':not(:last-child)' // Exclude the last column (Action column)
                }
              },
              {
                extend: 'pdfHtml5',
                text: 'Export PDF',
                exportOptions: {
                  columns: ':not(:last-child)' // Exclude the last column (Action column)
              }
            }
          ],
            "ajax": {
                    "url": "{% url 'chatHistory' %}",
                    "type": "POST",
                    "data": function(d) {
                        // Add date filter parameters to the AJAX request data
                        d.fromDate = $('#from-date').val();
                        d.toDate = $('#to-date').val();
                        d.search = $('.dataTables_filter input').val();
                      return d; 
                    },
                    "dataSrc": function(json) {
                        // Modify the JSON data to handle nested rows for each response
                        if (json && json.data && json.data.length > 0) {
                          return json.data;
                      } else {
                          // Show a message when no records are found
                          $('#chatHistory tbody').html('<tr><td colspan="8" class="text-center">No records found</td></tr>');
                          return [];
                      }
                    }
                },
                "columns": [
                    { "data": "date" },
                    { "data": "time" },
                    {
                        "data": "session_id",
                        "render": function(data, type, row) {
                            return `<a href="#" class="session-id-btn"  data-session_id="${data}" data-ip_address="${row.ip_address}">${data}</a>`;
                        },
                        
                    },
                    { "data": "ip_address" },
                    { "data": "total_token_used" },
                    { "data": "total_token_cost" },
                    {
                        "data": "session_id",
                        "render": function(data, type, row) {
                            return `<a href="#" class="btn btn-primary session-id-btn" data-session_id="${data}" data-ip_address="${row.ip_address}"><i class="fas fa-eye"></i></a>`;
                        }
                    }
                ],
                "searching": true,
                "paging": true,
                "regex" : true,
                "lengthChange": true,
                "ordering": false,
                "info": true,
                "autoWidth": true,
                dom: 'Blfrtip',
                "footerCallback": function (row, data, start, end, display) {                
                //Get data here 
                var api = this.api();

                // Total for tokens_used column
                var tokensUsedTotal = api.column(4, {page: 'current'}).data().reduce(function(acc, val) {
                    return acc + parseFloat(val);
                }, 0);
    
                // Total for tokens_cost column
                var tokensCostTotal = api.column(5, {page: 'current'}).data().reduce(function(acc, val) {
                    return acc + parseFloat(val);
                }, 0);
    
                // Update footer
                $(api.column(4).footer()).html(tokensUsedTotal.toFixed(2));
                $(api.column(5).footer()).html(tokensCostTotal.toFixed(3));
                }
            });

            // Datepicker initialization
            $(".datepicker").datepicker({
                dateFormat: 'yy-mm-dd'
            });

            // Filter button click event
            $('#filter').click(function() {
              if ($('#from-date').val() === '' || $('#to-date').val() === '') {
                alert('Please select both From and To dates.');
                return false; // Prevent form submission or further processing
            }
                var fromDate = $('#from-date').val();
                var toDate = $('#to-date').val();
                
                table.ajax.url('{% url 'chatHistory' %}?fromDate=' + fromDate + '&toDate=' + toDate).load();
            });

            $('#resetBtn').click(function() {
              $('.datepicker').val('');  // Clear datepicker value
              var fromDate = $('#from-date').val();
              var toDate = $('#to-date').val();
              // Redraw the DataTable
              table.ajax.url('{% url 'chatHistory' %}?fromDate=' + fromDate + '&toDate=' + toDate).load();
          });
        });

        

        $('#chatHistory').on('click', '.session-id-btn', function() {
             // Get session_id from clicked button
            let session_id = $(this).data('session_id'); // Get session_id from clicked button
            let ip_address = $(this).data('ip_address'); // Get ip_address from clicked button
            let sessionData = getSessionData(session_id,ip_address);
        });

        // Function to fetch session data based on session_id
        function getSessionData(session_id,ip_address) {
            let sessionData = [];
            var settings = {
                "url": "{% url 'sessionHistory' %}",
                "method": "POST",
                "timeout": 0,
                "headers": {
                  "Authorization": "token 8baa4ffcbc8a8cd3eef5f4ba36686b67a48d4465",
                  "Content-Type": "application/json"
                },
                "data": JSON.stringify({
                  "session_id": session_id
                }),
              };
              
              $.ajax(settings)
                .done(function (response) {

                    $('#sessionDetailsBody').empty();
                    let responses = response[0].responses;
                    // Populate modal content with session details
                    responses.forEach(function(data) {
                        
                        let row = '<tr>' +
                            '<td>' + data.query + '</td>' +
                            '<td style=" white-space: normal;">' + data.response + '</td>' +
                            '<td>' + data.token_used + '</td>' +
                            '<td>' + data.total_cost.toFixed(4) + '</td>' +
                            '</tr>';
                        $('#sessionDetailsBody').append(row);
                    });
                    // Set the session_id and IP address in the modal
                    $('#modalSessionId').text(session_id);
                    $('#modalIpAddress').text(ip_address);
                    
                    // Open modal
                    $('#sessionModal').modal('show');
                    // Call any function that needs to use sessionData here,
                    // since this code block executes after the AJAX request completes.
                   
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    console.error("Error fetching session data:", textStatus, errorThrown);
                });
        }
  </script>
  {% endblock javascripts %}
</div>

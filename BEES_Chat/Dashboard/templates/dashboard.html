{% extends 'layouts/base.html' %} 
{% block title %} Dashboard {% endblock title%}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css"/>
<!-- Buttons CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
<script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
<!-- Add these in the <head> section of your HTML -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<!-- Buttons JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.flash.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.print.min.js"></script>
<!-- PDFMake JS -->
<script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>

<style>
  .dt-button {
    background-color: #007bff !important; /* Change to your desired color */
    color: white !important; /* Change to your desired text color */
    border: none; /* Remove the border */
    padding: 10px 20px; /* Adjust padding as needed */
    border-radius: 4px; /* Adjust border-radius as needed */
    margin-right: 5px; /* Add margin between buttons */
}

.dt-button:hover {
    background-color: #0056b3 !important; /* Change to a darker shade on hover */
    color: white !important; /* Ensure text color stays the same on hover */
}

.buttons-csv {
  background-color: #28a745 !important; /* Green background */
  color: white !important;
}

.buttons-excel {
  background-color: #ffc107 !important; /* Yellow background */
  color: black !important;
}

.buttons-pdf {
  background-color: #dc3545 !important; /* Red background */
  color: white !important;
}

</style>
{% endblock stylesheets %} 
{% block content %}

<!-- Header -->
<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <!-- Card stats -->
    </div>
  </div>
</div>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="row">
    <div class="col">
      <div class="card">
        <!-- Card header -->
        <div class="card-header border-0">
          <h3 class="mb-0">Chat History</h3>
        </div>

        <div class="mt-3 ml-3">
          <label for="from-date">From: </label>
          <input type="text" id="from-date" class="datepicker" required/>
          <label for="to-date">To: </label>
          <input type="text" id="to-date" class="datepicker" required/>
          <button class="btn btn-success" id="filter">Filter</button>
          <button class="btn btn-danger" id="resetBtn">Reset</button>
        </div>
        <br /><br />
        <table id="chatHistory" class="display">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Session ID</th>
              <th>IP Address</th>
              <th>Token Used</th>
              <th>Tokens Cost</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populate this with chat history data -->
          </tbody>
        </table>
      </div>
    </div>
    <!-- Dark table -->
  </div>



  <!-- Modal -->
  <div class="modal fade" id="sessionModal" tabindex="-1" aria-labelledby="sessionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered  modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger"  id="sessionModalLabel">Session Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <table id="sessionDetailsTable" class="table table-bordered"style="width: 100%">
            <div class="row">
              <div class="col-md-2"><b>Session Id:</b></div>
              <div class="col-md-5" id="modalSessionId"></div>
              <div class="col-md-2"><b>IP Address:</b></div>
              <div class="col-md-3" id="modalIpAddress"></div>
          </div>
            <hr>
            <thead>
              <tr>
                <th>Query</th>
                <th style=" white-space: normal;">Response</th>
                <th>Token Used</th>
                <th>Total Cost</th>
              </tr>
            </thead>
            <tbody id="sessionDetailsBody">
              <!-- Data will be populated dynamically -->
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  {% endblock content %}

  <!-- Specific JS goes HERE -->
  {% block javascripts %}
  <script src="/static/assets/vendor/chart.js/dist/Chart.min.js"></script>
  <script src="/static/assets/vendor/chart.js/dist/Chart.extension.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    $(document).ready(function() {
        var table=$('#chatHistory').DataTable({
          dom: 'Bfrtip',
          buttons: [
              
              {
                  extend: 'excelHtml5',
                  text: 'Export Excel',
                  exportOptions: {
                    columns: ':not(:last-child)' // Exclude the last column (Action column)
                }
              },
              {
                extend: 'pdfHtml5',
                text: 'Export PDF',
                exportOptions: {
                  columns: ':not(:last-child)' // Exclude the last column (Action column)
              }
            }
          ],
            "ajax": {
                    "url": "{% url 'chatHistory' %}",
                    "data": function(d) {
                        // Add date filter parameters to the AJAX request data
                        d.fromDate = $('#from-date').val();
                        d.toDate = $('#to-date').val();
                    },
                    "dataSrc": function(json) {
                        // Modify the JSON data to handle nested rows for each response
                        let newData = [];

                        json.forEach(function(item) {
                            
                            let datetime = new Date(item.datetime);
                            let totalTokenUsed = 0;
                            let totalTokenCost = 0;

                            item.responses.forEach(function(response) {

                                totalTokenUsed += response.token_used;
                                totalTokenCost += response.total_cost;
                            });

                        newData.push({
                            "date": datetime.toISOString().split('T')[0],
                            "time": datetime.toTimeString().split(' ')[0],
                            "session_id": item.session_id,
                            "ip_address": item.ip_address,
                            "total_token_used": totalTokenUsed,
                            "total_token_cost": totalTokenCost.toFixed(4),
                            "session_data": item.responses// Fixing to 4 decimal places
                        });
                    });
                        return newData;
                    }
                },
                "columns": [
                    { "data": "date" },
                    { "data": "time" },
                    {
                        "data": "session_id",
                        "render": function(data, type, row) {
                            return `<a href="#" class="session-id-btn"  data-session_id="${data}" data-ip_address="${row.ip_address}">${data}</a>`;
                        },
                        
                    },
                    { "data": "ip_address" },
                    { "data": "total_token_used" },
                    { "data": "total_token_cost" },
                    {
                        "data": "session_id",
                        "render": function(data, type, row) {
                            return `<a href="#" class="btn btn-primary session-id-btn" data-session_id="${data}" data-ip_address="${row.ip_address}"><i class="fas fa-eye"></i></a>`;
                        }
                    }
                ]
            });

            // Datepicker initialization
            $(".datepicker").datepicker({
                dateFormat: 'yy-mm-dd'
            });

            // Filter button click event
            $('#filter').click(function() {
              if ($('#from-date').val() === '' || $('#to-date').val() === '') {
                alert('Please select both From and To dates.');
                return false; // Prevent form submission or further processing
            }
                var fromDate = $('#from-date').val();
                var toDate = $('#to-date').val();
                
                table.ajax.url('{% url 'chatHistory' %}?fromDate=' + fromDate + '&toDate=' + toDate).load();
            });

            $('#resetBtn').click(function() {
              $('.datepicker').val('');  // Clear datepicker value
              var fromDate = $('#from-date').val();
              var toDate = $('#to-date').val();
              // Redraw the DataTable
              table.ajax.url('{% url 'chatHistory' %}?fromDate=' + fromDate + '&toDate=' + toDate).load();
          });
        });

        

        $('#chatHistory').on('click', '.session-id-btn', function() {
             // Get session_id from clicked button
            let session_id = $(this).data('session_id'); // Get session_id from clicked button
            let ip_address = $(this).data('ip_address'); // Get ip_address from clicked button
            let sessionData = getSessionData(session_id,ip_address);
        });

        // Function to fetch session data based on session_id
        function getSessionData(session_id,ip_address) {
            let sessionData = [];
            let csrfToken = $('[name="csrfmiddlewaretoken"]').val();
            var settings = {
                "url": "{% url 'sessionHistory' %}",
                "method": "POST",
                "timeout": 0,
                "headers": {
                  "Authorization": "token 8baa4ffcbc8a8cd3eef5f4ba36686b67a48d4465",
                  "Content-Type": "application/json",
                  'X-CSRFToken': csrfToken
                },
                "data": JSON.stringify({
                  "session_id": session_id
                }),
              };
              
              $.ajax(settings)
                .done(function (response) {

                    $('#sessionDetailsBody').empty();
                    let responses = response[0].responses;
                    // Populate modal content with session details
                    responses.forEach(function(data) {
                        
                        let row = '<tr>' +
                            '<td>' + data.query + '</td>' +
                            '<td style=" white-space: normal;">' + data.response + '</td>' +
                            '<td>' + data.token_used + '</td>' +
                            '<td>' + data.total_cost.toFixed(4) + '</td>' +
                            '</tr>';
                        $('#sessionDetailsBody').append(row);
                    });
                    // Set the session_id and IP address in the modal
                    $('#modalSessionId').text(session_id);
                    $('#modalIpAddress').text(ip_address);
                    
                    // Open modal
                    $('#sessionModal').modal('show');
                    // Call any function that needs to use sessionData here,
                    // since this code block executes after the AJAX request completes.
                   
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    console.error("Error fetching session data:", textStatus, errorThrown);
                });
        }
  </script>
  {% endblock javascripts %}
</div>
